---
layout: post
title: C# Wrapper for AllJoyn via SWIG
date: '2016-03-02T10:31:00.002+09:00'
author: 'Contact:'
tags:
- alljoyn
- swig
- c#
modified_time: '2016-03-02T10:31:39.663+09:00'
blogger_id: tag:blogger.com,1999:blog-5371326417913853395.post-9177126804696905079
blogger_orig_url: http://rendered-obsolete.blogspot.com/2016/03/c-wrapper-for-alljoyn-via-swig.html
---

I was original interested in <a href="https://allseenalliance.org">AllJoyn</a> because it looked like a good way to build local multiplayer mobile games.  At one point a few years back they even provided a <a href="https://unity3d.com/">Unity3D</a> library.  I got a simple "hello world" app working on PC/iOS/Android, but then got busy with other things and the project was eventually cancelled.  <p/> I've been thinking about it again and looking at ways of getting it into .Net applications.  Unfortunately they no longer provide the Unity library which would have given me a good start.  <p/> Ran into some issues with their <a href="https://allseenalliance.org/framework/documentation/develop/building/linux">Linux build instructions</a>.  apt-get didn't want to install ia32-libs since I already had ncurses installed.  Next, the src zip directory structure didn't quite match what's in the documentation (I guess they want you to move directories around).  But you can just run scons from the root of the decompressed source code.  I got a compile error about not being able to find sys/capability.h.  apt-get had given up ia32-libs and didn't install libcap-dev.  Once I got that everything seemed to work.  <p/> Basically, I ended up doing: <pre class="code"><br />sudo apt-get install build-essential libgtk2.0-dev libssl-dev xsltproc libxml2-dev libcap-dev python scons libssl-dev<br />scons BINDINGS=cpp WS=off BT=off ICE=off SERVICES="about"<br /></pre> <p/> You can verify everything works by <a href="https://allseenalliance.org/framework/documentation/develop/run-sample-apps/basic/linux">running the sample app</a>.  On a 64-bit system scons seems to build for x86_64 by default.  <p/> In one shell: <ol><li>export LD_LIBRARY_PATH=`pwd`/build/linux/x86_64/debug/dist/cpp/lib:$LD_LIBRARY_PATH</li><li>build/linux/x86_64/debug/dist/cpp/bin/samples/basic_service</li></ol> And in another: <ol><li>export LD_LIBRARY_PATH=`pwd`/build/linux/x86_64/debug/dist/cpp/lib:$LD_LIBRARY_PATH</li><li>build/linux/x86_64/debug/dist/cpp/bin/samples/basic_client</li></ol> Now I've got the native AllJoyn library, but I still need to get it working with .Net.  <a href="http://www.swig.org/">SWIG</a> is my first thought to do this.  <a href="http://clrinterop.codeplex.com/releases/view/14120">PInvoke Interop Assistant</a> is potentially another option, but it looks like it hasn't been developed for some time.  Following the <a href="http://www.swig.org/tutorial.html">SWIG tutorial</a> I created the interface file alljoyn.swig specifying header files included by samples/basic/basic_client.cc:  <pre class="code"><br />%module alljoyn<br />%{<br />/* Includes the header in the wrapper code */<br />#include "alljoyn_core/inc/alljoyn/AllJoynStd.h"<br />#include "alljoyn_core/inc/alljoyn/BusAttachment.h"<br />#include "build/linux/x86_64/debug/dist/cpp/inc/alljoyn/Status.h"<br />#include "alljoyn_core/inc/alljoyn/Init.h"<br />#include "alljoyn_core/inc/alljoyn/version.h"<br /><br />// Needed for alljoyn_wrap.cxx to compile<br />using namespace qcc;<br />using namespace ajn;<br />%}<br /><br />/* Parse the header file to generate wrappers */<br />%include "alljoyn_core/inc/alljoyn/AllJoynStd.h"<br />%include "alljoyn_core/inc/alljoyn/BusAttachment.h"<br />%include "build/linux/x86_64/debug/dist/cpp/inc/alljoyn/Status.h"<br />%include "alljoyn_core/inc/alljoyn/Init.h"<br />%include "alljoyn_core/inc/alljoyn/version.h"<br /></pre> Then build everything: <pre class="code"><br />mkdir alljoyn_cs<br />cd alljoyn_cs<br /># Create alljoyn.swig here<br /><br /># Generate SWIG wrapper code<br />swig -c++ -csharp -cpperraswarn alljoyn.swig<br /><br /># Build shared lib<br />g++ -fPIC -c -DQCC_OS_GROUP_POSIX -I../build/linux/x86_64/debug/dist/cpp/inc -I../alljoyn_core/inc -I../common/inc alljoyn_wrap.cxx<br />g++ -shared -L../build/linux/x86_64/debug/dist/cpp/lib -o liballjoyn.so alljoyn_wrap.o -lajrouter -Wl,-Bstatic -lalljoyn -Wl,-Bdynamic -lssl -lcrypto<br /><br /># Update so mono can find liballjoyn.so<br />export LD_LIBRARY_PATH=`pwd`:$LD_LIBRARY_PATH<br /></pre> I included all the swig generated csharp source files into a MonoDevelop project, and you can now call simple AllJoyn functions from C#:  <pre class="code"><br />if (alljoyn.AllJoynInit () != QStatus.ER_OK)<br /> return;<br /><br />Console.WriteLine ("AllJoyn Library version: {0}", alljoyn.GetVersion ());<br />Console.WriteLine ("AllJoyn Library build info: {0}", alljoyn.GetBuildInfo ());<br /><br />var status = QStatus.ER_OK;<br /><br />var msgBus = new BusAttachment ("myApp", true);<br />if (msgBus == null)<br /> status = QStatus.ER_OUT_OF_MEMORY;<br /></pre> That's a good start, but I've run into a problem.  As expected, swig doesn't always generate "natural" c# code.  BusAttachment.CreateInterface() has the following signature: <pre class="code"><br />public QStatus CreateInterface(string name, SWIGTYPE_p_p_InterfaceDescription iface)<br /></pre>Where SWIGTYPE_p_p_InterfaceDescription is some pointer wrapper for the managed/unmanaged magic that swig generated for us rather than something like "out InterfaceDescription".  It looks like swig provides <a href="http://www.swig.org/Doc1.3/Typemaps.html">typemaps</a> to solve these sorts of problems, but in any case I'm not quite done yet.  Misc other docs that were helpful: <ul><li><a href="http://www.mono-project.com/docs/advanced/pinvoke/dllnotfoundexception/">http://www.mono-project.com/docs/advanced/pinvoke/dllnotfoundexception/</a></li><li>https://github.com/swig/swig/blob/master/Lib/csharp/typemaps.i</li></ul>