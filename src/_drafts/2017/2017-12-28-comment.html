---
layout: post
title: Porting MEF1 to MEF2
date: '2017-12-28T10:22:00.000+09:00'
author: 'Contact:'
tags:
- mef
- netcore
- c#
- netstandard
modified_time: '2017-12-28T10:22:27.532+09:00'
blogger_id: tag:blogger.com,1999:blog-5371326417913853395.post-243768856367339238
blogger_orig_url: https://www.blogger.com/comment.g?blogID=5371326417913853395&postID=243768856367339238
---

<h3>MEF1 and MEF2</h3>While moving part of our codebase to <a href="https://msdn.microsoft.com/en-us/magazine/mt842506.aspx">.NetStandard 2.0 so everything runs atop .NetCore</a>, we had to deal with moving from <a href="https://docs.microsoft.com/en-us/dotnet/framework/mef/">MEF1</a> to <a href="https://www.nuget.org/packages/microsoft.composition">MEF2</a>.<br /><br /><a href="http://blog.softwarepotential.com/porting-to-net-standard-2-0-part-2-porting-mef-1-0-to-mef-2-0-on-net-core/">This blog post</a> got me started, or at least validated that the move was possible, rather.&nbsp; But, it didn't really have the details matching our usage.<br /><br />The simplest changes involved is moving from .NetFramework:<br /><pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> using System.ComponentModel.Composition;  <br /> using System.ComponentModel.Composition.Hosting;  <br /></code></pre>To packages available from nuget:<br /><pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> using System.Composition;  <br /> using System.Composition.Hosting;  </code></pre><br />It's worth mentioning that System.ComponentModel.DataAnnotations can be used as-is, but the package still has to be downloaded from nuget.<br /><br /><h3>Code Changes</h3>It seems that several other people are dealing with similar issues, because there were several StackOverflow questions that were helpful:<br /><ul><li><a href="https://stackoverflow.com/questions/41784393/how-to-emit-a-type-in-net-core">https://stackoverflow.com/questions/41784393/how-to-emit-a-type-in-net-core</a></li><li><a href="https://stackoverflow.com/questions/24935261/mef2-how-to-get-metadata-from-compositionhost-export-with-convention-based-impor">https://stackoverflow.com/questions/24935261/mef2-how-to-get-metadata-from-compositionhost-export-with-convention-based-impor</a></li><li><a href="https://stackoverflow.com/questions/13914256/strongly-typed-metadata-in-mef2-system-composition">https://stackoverflow.com/questions/13914256/strongly-typed-metadata-in-mef2-system-composition</a></li><li><a href="https://stackoverflow.com/questions/10988447/mef-getexportst-tmetadataview-returning-nothing-with-allowmultiple-true">https://stackoverflow.com/questions/10988447/mef-getexportst-tmetadataview-returning-nothing-with-allowmultiple-true</a></li></ul><br />We had a DynamicLinq.cs:<br /><pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> AssemblyBuilder assembly = AppDomain.CurrentDomain.DefineDynamicAssembly(name, AssemblyBuilderAccess.Run);  <br /> // SNIP<br /> Type result = tb.CreateType();</code></pre>That needed to get changed to:<br /><pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> AssemblyBuilder assembly = AssemblyBuilder.DefineDynamicAssembly(name, AssemblyBuilderAccess.Run);  <br /> // SNIP<snip><br /> Type result = tb.CreateTypeInfo();</snip></code></pre><br />A more complicated case is how we load the assemblies, first via MEF1:<br /><pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">1:   CompositionContainer container;  <br />2:   [ImportMany(typeof(IWorker))]  <br />3:   IEnumerable&lt;Lazy&lt;IWorker, IWorkerMetadata&gt;&gt; workerPlugins { get; set; }  <br />4:   [ImportMany(typeof(IForwarder))]  <br />5:   IEnumerable&lt;Lazy&lt;IForwarder, IWorkerMetadata&gt;&gt; forwarderPlugins { get; set; }  <br />6:   public void Init(string path)  <br />7:   {  <br />8:     var files = Directory.EnumerateFiles(path, "*Service.dll", SearchOption.AllDirectories);  <br />9:     var catalog = new AggregateCatalog();  <br />10:    foreach (var file in files)  <br />11:    {  <br />12:      try  <br />13:      {  <br />14:        var asmCat = new AssemblyCatalog(file);  <br />15:        if (asmCat.Parts.ToList().Count &gt; 0)  <br />16:          catalog.Catalogs.Add(asmCat);  <br />17:      }  <br />18:      catch (ReflectionTypeLoadException)  <br />19:      {  <br />20:      }  <br />21:      catch (BadImageFormatException)  <br />22:      {  <br />23:      }  <br />24:    }  <br />25:    container = new CompositionContainer(catalog);  <br />26:    container.ComposeParts(this);  <br />27:  }  <br /></code></pre><br />And then with MEF2:<br /><pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">1:  CompositionHost container;  <br />2:  public void Init(string path)  <br />3:  {  <br />4:    var configuration = new ContainerConfiguration();  <br />5:    var files = Directory.EnumerateFiles(path, "*Service.dll", SearchOption.AllDirectories);  <br />6:    foreach (var file in files)  <br />7:    {  <br />8:      try  <br />9:      {  <br />10:        var asm = Assembly.LoadFrom(file);  <br />11:        configuration.WithAssembly(asm);  <br />12:      }  <br />13:      catch (ReflectionTypeLoadException)  <br />14:      {  <br />15:      }  <br />16:      catch (BadImageFormatException)  <br />17:      {  <br />18:      }  <br />19:    }  <br />20:    container = configuration.CreateContainer();  <br />21:  }  <br /></code></pre><br />Both of these are simplified but should still be illustrative.<br /><h3>Side-by-Side</h3><div>Unfortunately, we've got a few dependencies that are incompatible with .netstandard.&nbsp; This means we've got some assemblies that can be loaded with MEF2 and a few&nbsp;</div>